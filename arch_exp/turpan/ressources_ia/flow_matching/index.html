<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-arch_exp/turpan/ressources_ia/flow_matching">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Flow Matching | Documentation de MesoNET</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://your-docusaurus-test-site.com/documentation/user-documentation/img/logomeso.png"><meta data-rh="true" name="twitter:image" content="https://your-docusaurus-test-site.com/documentation/user-documentation/img/logomeso.png"><meta data-rh="true" property="og:url" content="https://your-docusaurus-test-site.com/documentation/user-documentation/arch_exp/turpan/ressources_ia/flow_matching"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Flow Matching | Documentation de MesoNET"><meta data-rh="true" name="description" content="Guide complet pour exécuter facebookresearch/flow_matching sur Turpan."><meta data-rh="true" property="og:description" content="Guide complet pour exécuter facebookresearch/flow_matching sur Turpan."><link data-rh="true" rel="icon" href="/documentation/user-documentation/img/faviconM.ico"><link data-rh="true" rel="canonical" href="https://your-docusaurus-test-site.com/documentation/user-documentation/arch_exp/turpan/ressources_ia/flow_matching"><link data-rh="true" rel="alternate" href="https://your-docusaurus-test-site.com/documentation/user-documentation/arch_exp/turpan/ressources_ia/flow_matching" hreflang="en"><link data-rh="true" rel="alternate" href="https://your-docusaurus-test-site.com/documentation/user-documentation/arch_exp/turpan/ressources_ia/flow_matching" hreflang="x-default"><link rel="stylesheet" href="/documentation/user-documentation/assets/css/styles.89ad5c2c.css">
<link rel="preload" href="/documentation/user-documentation/assets/js/runtime~main.133bebb2.js" as="script">
<link rel="preload" href="/documentation/user-documentation/assets/js/main.55ebcb72.js" as="script">
</head>
<body class="navigation-with-keyboard" data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/documentation/user-documentation/"><div class="navbar__logo"><img src="/documentation/user-documentation/img/logomeso.png" alt="MesoNet Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/documentation/user-documentation/img/logomeso.png" alt="MesoNet Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/documentation/user-documentation/">Documentation</a><a href="https://acces.mesonet.fr/gramc-meso/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Portail</a><a href="https://mesonet.fr" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Site web</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-current"></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/documentation/user-documentation/">Accueil</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/documentation/user-documentation/category/le-portail-mesonet">Le portail MesoNET</a><button aria-label="Toggle the collapsible sidebar category &#x27;Le portail MesoNET&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/documentation/user-documentation/category/machine-codeformation">Machine Code/Formation</a><button aria-label="Toggle the collapsible sidebar category &#x27;Machine Code/Formation&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/documentation/user-documentation/category/architectures-de-prototypage-et-spécialisées">Architectures de Prototypage et Spécialisées</a><button aria-label="Toggle the collapsible sidebar category &#x27;Architectures de Prototypage et Spécialisées&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/documentation/user-documentation/arch_exp/boreal/description">Boreale, la machine vectorielle</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/documentation/user-documentation/arch_exp/turpan/">Turpan, la machine ARM</a><button aria-label="Toggle the collapsible sidebar category &#x27;Turpan, la machine ARM&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/documentation/user-documentation/arch_exp/turpan/Actualité">Actualités</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/documentation/user-documentation/arch_exp/turpan/description">Description</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/documentation/user-documentation/arch_exp/turpan/connexion/">Se connecter à Turpan</a><button aria-label="Toggle the collapsible sidebar category &#x27;Se connecter à Turpan&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/documentation/user-documentation/arch_exp/turpan/ressources_ia/">Ressources pour l&#x27;IA</a><button aria-label="Toggle the collapsible sidebar category &#x27;Ressources pour l&#x27;IA&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-4 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/documentation/user-documentation/arch_exp/turpan/ressources_ia/HPO/">Hyperparameter Optimization (HPO)</a><button aria-label="Toggle the collapsible sidebar category &#x27;Hyperparameter Optimization (HPO)&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/documentation/user-documentation/arch_exp/turpan/ressources_ia/flow_matching">Flow Matching</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/documentation/user-documentation/arch_exp/turpan/soumettre_calcul/">Lancer un calcul</a><button aria-label="Toggle the collapsible sidebar category &#x27;Lancer un calcul&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/documentation/user-documentation/arch_exp/turpan/stockage">Le stockage</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/documentation/user-documentation/arch_exp/turpan/accounting/accounting-rules">L&#x27;accounting</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/documentation/user-documentation/arch_exp/turpan/softenv">Environnement de développement</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/documentation/user-documentation/arch_exp/turpan/logiciels/">Les logiciels installés</a><button aria-label="Toggle the collapsible sidebar category &#x27;Les logiciels installés&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/documentation/user-documentation/arch_exp/turpan/datasets">Les jeux de données</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/documentation/user-documentation/arch_exp/turpan/performance/">Améliorer les performances</a><button aria-label="Toggle the collapsible sidebar category &#x27;Améliorer les performances&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/documentation/user-documentation/arch_exp/turpan/Quick_start/slurm">Démarrage rapide</a></div></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/documentation/user-documentation/category/tutoriaux">Tutoriaux</a><button aria-label="Toggle the collapsible sidebar category &#x27;Tutoriaux&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/documentation/user-documentation/category/support">Support</a><button aria-label="Toggle the collapsible sidebar category &#x27;Support&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/documentation/user-documentation/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/documentation/user-documentation/category/architectures-de-prototypage-et-spécialisées"><span itemprop="name">Architectures de Prototypage et Spécialisées</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/documentation/user-documentation/arch_exp/turpan/"><span itemprop="name">Turpan, la machine ARM</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/documentation/user-documentation/arch_exp/turpan/ressources_ia/"><span itemprop="name">Ressources pour l&#x27;IA</span></a><meta itemprop="position" content="3"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Flow Matching</span><meta itemprop="position" content="4"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Flow Matching sur Turpan</h1><p>Ce document facilite l’exécution du dépôt <a href="https://github.com/facebookresearch/flow_matching" target="_blank" rel="noopener noreferrer">https://github.com/facebookresearch/flow_matching</a> sur Turpan. Le contenu du dépôt GitHub a été copié dans un répertoire du cluster et adapté par plusieurs modifications pratiques est désormais disponible dans un répertoire dédié du cluster pour une utilisation directe.</p><p>L’exemple reproduit correspond au cas d’images ImageNet32 (Blurred) utilisant un modèle de type Class-conditional UNet. Le test s’exécute sur 900 époques et atteint un FID de 1.16, très proche de la valeur de référence 1.14 indiquée dans le dépôt. Cet accord valide la reproduction du test, l’écart observé restant entièrement dans la variabilité attendue pour ce type de mesure.</p><p>L’article associé au dépôt est disponible ici : <a href="https://arxiv.org/pdf/2412.06264" target="_blank" rel="noopener noreferrer">https://arxiv.org/pdf/2412.06264</a></p><p>Vous trouvez ici : </p><ul><li><a href="#preparation-du-projet-recuperation-du-dossier--installation-de-dependences">Preparation du projet</a> </li><li><a href="#lancer-le-calcul">Lancer le calcul</a></li><li><a href="#r%C3%A9sultats-dex%C3%A9cution-attendus-sur-le-cluster">Résultats d&#x27;exécution attendus</a></li></ul><p>Tout est prêt à copier / coller.</p><p>Il y a aussi une deuxième partie, non indispensable pour exécuter le cas test, mais qui offre une vue d’ensemble sur la préparation des données et les adaptations du code mises en place pour assurer le bon fonctionnement du cas test et des scripts utiles:
<strong>Parametrage du test et préparation des donnes:</strong>
<a href="#details-de-la-mis-en-place-du-test">Détails du test</a> |
<a href="#script-slurm-apptainer--multin%C5%93uds">Slurm multi-nœuds</a> |
<a href="#pr%C3%A9paration-du-dataset-imagenet32-blurred">Dataset ImageNet32</a> |
<a href="#t%C3%A9l%C3%A9chargement-dinception-v3-poids-pour-fid">Inception v3 FID</a> |
<strong>Changements sur code source:</strong> <a href="#modifications-apport%C3%A9es-au-code">Modifications du code</a> |
<a href="#non-utilisation-de-submitit_trainpy">Pas de submitit.py</a> |
<strong>Scripts et outils d’analyse:</strong> <a href="#script-danalyse-et-de-visualisation-de-lapprentissage-du-mod%C3%A8le-process_and_plot_lr_losspy">Script d’analyse et de visualisation</a> | <a href="#script-slurm-pour-lancer-l%C3%A9valuation-fid-depuis-un-checkpointpth--script_sbatch_evaluationsh">ExtraScript Slurm FID</a> |</p><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="preparation-du-projet-recuperation-du-dossier--installation-de-dependences">Preparation du projet. Recuperation du dossier + installation de dependences.<a href="#preparation-du-projet-recuperation-du-dossier--installation-de-dependences" class="hash-link" aria-label="Direct link to Preparation du projet. Recuperation du dossier + installation de dependences." title="Direct link to Preparation du projet. Recuperation du dossier + installation de dependences.">​</a></h2><p>Pour faciliter le déploiement, le code modifié ainsi que le dataset ImageNet et sa version transformée en 32 blurred sont directement accessibles sur le cluster.
Les modifications réalisées ainsi que les commandes nécessaires pour préparer ce répertoire sont spécifiées en bas de cette page.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">tar</span><span class="token plain"> xf /work/shares/IA-Tests/flow_matching_facebook.tar.gz  </span><span class="token comment" style="color:#999988;font-style:italic"># Cela prends ~ 43 minutes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">cd</span><span class="token plain"> flow_matching_facebook</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apptainer shell --nv --bind /tmpdir,/work --nv /work/conteneurs/sessions-interactives/pytorch-25.01-py3-calmip-si-latest.sif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Apptainer</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> pip </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> -e </span><span class="token builtin class-name">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Cntrl + d  //Pour sortir </span><span class="token function" style="color:#d73a49">du</span><span class="token plain"> container</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="lancer-le-calcul">Lancer le calcul<a href="#lancer-le-calcul" class="hash-link" aria-label="Direct link to Lancer le calcul" title="Direct link to Lancer le calcul">​</a></h2><p>Pour démarrer l’entraînement, il suffit d’exécuter :</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">cd</span><span class="token plain"> flow_matching_facebook/examples/image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sbatch script_sbatch.sh</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Ce script lance automatiquement le code en mode distribué sur le nombre de nœuds et avec 2 GPUs par nœud.
Le seul paramètre à modifier pour changer le nombre total de nœuds/GPUs utilisés est</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">#SBATCH --nodes=6</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 style="font-size:1.1rem"> Le processus complet est donc le suivant </h3><ol><li>Lancer le premier job :</li></ol><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sbatch script_sbatch.sh</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Cela vous donne un <code>&lt;FIRST_JOBID&gt;</code></p><ol start="2"><li>Lancer plusieurs exécutions avec dépendances (10 fois dans cet exemple) :</li></ol><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./launch_chain.sh </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"> script_sbatch.sh </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">FIRST_JOBID</span><span class="token operator" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>La partition small a un temps d’exécution maximal de 4 heures. Pour lancer un entraînement long, ce script enchaîne plusieurs jobs Slurm avec des dépendances.
Lorsqu’un job se termine, le suivant reprend l’entraînement là où le précédent s’était arrêté.</p><ol start="3"><li>Vérifier que tout est en place :</li></ol><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">squeue --me</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="résultats-dexécution-attendus-sur-le-cluster">Résultats d’exécution attendus sur le cluster.<a href="#résultats-dexécution-attendus-sur-le-cluster" class="hash-link" aria-label="Direct link to Résultats d’exécution attendus sur le cluster." title="Direct link to Résultats d’exécution attendus sur le cluster.">​</a></h2><p>Cet exemple présente les performances obtenues lors de l’entraînement du modèle Class-Conditional U-Net sur ImageNet32 (blurred) en utilisant :</p><ul><li>6 nœuds Turpan</li><li>12 GPU NVIDIA A100 (80 Go) </li></ul><p>et les options suivantes du script train.py :</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        --lr 4e-4 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        --batch_size </span><span class="token number" style="color:#36acaa">512</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        --eval_frequency </span><span class="token number" style="color:#36acaa">100</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        --accum_iter </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        --decay_lr </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        --compute_fid </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        --ode_method dopri5 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        --ode_options </span><span class="token string" style="color:#e3116c">&#x27;{\&quot;atol\&quot;: 1e-5, \&quot;rtol\&quot;:1e-5}&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>C&#x27;est le deuxieme test du tableau: <strong><a href="https://github.com/facebookresearch/flow_matching/tree/main/examples/image" target="_blank" rel="noopener noreferrer">https://github.com/facebookresearch/flow_matching/tree/main/examples/image</a></strong>
Le batch_size est incremente pour accelerer le calcul et le learning rate est modifie en consequence. <a href="#details-de-la-mis-en-place-du-test">Voir la section “Details de la mis en place du test”</a></p><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Résultats</div><div class="admonitionContent_S0QG"><p><strong>Temps d’exécution :</strong><br>
<!-- -->900 itérations → <strong>~65 h</strong> (2 jours et 17 heures)</p><p><strong>FID obtenu :</strong><br>
<strong>1.16</strong> ce qui est très proche du score de référence (1,14) et se situe pleinement dans la variabilité normale de la mesure.</p></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="script-danalyse-et-de-visualisation-de-lapprentissage-du-modèle-process_and_plot_lr_losspy">Script d’analyse et de visualisation de l’apprentissage du modèle process_and_plot_lr_loss.py<a href="#script-danalyse-et-de-visualisation-de-lapprentissage-du-modèle-process_and_plot_lr_losspy" class="hash-link" aria-label="Direct link to Script d’analyse et de visualisation de l’apprentissage du modèle process_and_plot_lr_loss.py" title="Direct link to Script d’analyse et de visualisation de l’apprentissage du modèle process_and_plot_lr_loss.py">​</a></h2><p>Ce script a été conçu pour faciliter le suivi de l’apprentissage d’un modèle pendant son entraînement. Il automatise trois étapes essentielles :</p><ol><li>Rassembler et nettoyer les logs
Le script parcourt tous les fichiers slurm-*.out générés lors des différentes exécutions du job.
Il n’en extrait que les lignes réellement utiles : celles contenant l’époque, la loss et le learning rate.
Ces lignes filtrées sont ensuite regroupées dans un fichier unique, clean_log.txt, ce qui permet d’avoir un historique clair et lisible de l’entraînement.</li><li>Parser les informations importantes
À partir du fichier nettoyé, le script reconstruit l’évolution :</li></ol><ul><li>de l’époque (sous forme fractionnaire, pour afficher la progression intra-époque),</li><li>de la loss,</li><li>du learning rate.
Cela permet d’obtenir une série temporelle continue, même lorsque l’entraînement s’étale sur plusieurs fichiers Slurm.</li></ul><ol start="3"><li>Générer des graphiques automatiquement
Deux courbes sont produites et enregistrées dans des images PNG :</li></ol><ul><li>loss_plot.png : évolution de la perte au fil de l’entraînement,</li><li>lr_plot.png : évolution du learning rate.
Ces graphiques permettent de visualiser immédiatement si l’apprentissage progresse correctement, si la loss converge ou si la politique de learning rate fonctionne comme prévu.</li></ul><p>Ce script est donc un outil pratique pour surveiller rapidement l’état de l’entraînement, diagnostiquer des problèmes éventuels (learning rate trop élevé, stagnation, divergence…) et visualiser la dynamique du modèle au fil du temps.</p><p>Pour l&#x27;utiliser:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">module load conda</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">conda activate python-tools-3.10.9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">python process_and_plot_lr_loss.py</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="script-slurm-pour-lancer-lévaluation-fid-depuis-un-checkpointpth--script_sbatch_evaluationsh">Script Slurm pour lancer l’évaluation FID depuis un checkpoint.pth : script_sbatch_evaluation.sh<a href="#script-slurm-pour-lancer-lévaluation-fid-depuis-un-checkpointpth--script_sbatch_evaluationsh" class="hash-link" aria-label="Direct link to Script Slurm pour lancer l’évaluation FID depuis un checkpoint.pth : script_sbatch_evaluation.sh" title="Direct link to Script Slurm pour lancer l’évaluation FID depuis un checkpoint.pth : script_sbatch_evaluation.sh">​</a></h2><p>Ce script Slurm sert à lancer automatiquement l’évaluation FID du modèle sur un GPU.</p><p>Il exécute :</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">python evaluate_fid.py </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --checkpoint output_dir/checkpoint.pth </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --num_images </span><span class="token number" style="color:#36acaa">50000</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --batch_size </span><span class="token number" style="color:#36acaa">4000</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Pour bien remplir le GPU sur une A100 80GB</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --data_path data/train_blurred_32/box/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Cela déclenche la génération d’images et le calcul du FID.</p><p>Pour l&#x27;utiliser:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sbatch script_sbatch_evaluation.sh</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Details du script:
Ce script réalise l’évaluation du modèle en plusieurs étapes :</p><ol><li>Chargement des paramètres d’entraînement</li></ol><p>À partir de args.json, il récupère toutes les options utilisées lors du training, afin de reconstruire la même architecture et il prends en compte le dernier checkpoint généré du modèle.</p><ol start="2"><li>Chargement du modèle</li></ol><p>À partir du output_dir/checkpoint.pth :</p><ul><li>récupération des poids,</li><li>reconstruction de l’architecture (Flow-Matching),</li></ul><ol start="3"><li>Construction du dataset réel</li></ol><p>Utilise ImageFolder et les mêmes transformations que pendant l’entraînement, pour garantir une comparaison correcte.</p><ol start="4"><li>Calcul du FID</li></ol><p>Appelle eval_model, qui :
•	génère num_images images,
•	calcule les statistiques réelles et générées,
•	produit le score FID.</p><ol start="5"><li>Sauvegarde des résultats</li></ol><p>Le FID est enregistré dans fid_results.json.</p><hr><h1>Details de la mis en place du test</h1><p>Pour améliorer l’efficacité globale de l’entraînement, le batch size est augmenté autant que le permet la mémoire GPU disponible. Un batch size plus élevé permet d’améliorer l’efficacité du calcul, de mieux exploiter le parallélisme du GPU et de réduire le temps total d’entraînement par epoch.
Lorsque le batch size est fortement augmenté, il est nécessaire d’ajuster le learning rate afin de conserver une dynamique d’apprentissage stable. Une règle couramment utilisée consiste à adapter le learning rate en fonction de la racine carrée du facteur d’augmentation du batch size.</p><p>Cas de base :</p><ul><li>Batch size d’origine : 32</li><li>Nouveau batch size : 512</li><li>Learning rate d’origine : 1×10⁻⁴</li></ul><p>Le ratio entre les deux batch sizes est :</p><ul><li>512 / 32 = 16</li><li>La racine carrée de 16 est 4.</li></ul><p>Donc le nouveau learning rate est :</p><ul><li>LR_nouveau = 1×10⁻⁴ × 4 = 4×10⁻⁴</li></ul><p>Ainsi, avec un batch size de 512 le learning rate utilisé est 4×10⁻⁴.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="script-slurm-apptainer--multinœuds">Script Slurm (Apptainer + multi‑nœuds)<a href="#script-slurm-apptainer--multinœuds" class="hash-link" aria-label="Direct link to Script Slurm (Apptainer + multi‑nœuds)" title="Direct link to Script Slurm (Apptainer + multi‑nœuds)">​</a></h2><p>Ici le sbatch script que utilisé :</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token shebang important">#!/bin/bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#SBATCH --job-name=flowmatching</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#SBATCH --nodes=6</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#SBATCH --ntasks=12</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#SBATCH --ntasks-per-node=2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#SBATCH --gres=gpu:2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#SBATCH --cpus-per-task=10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#SBATCH --time=04:00:00</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#SBATCH -p small</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># -------------------------------------------------------</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 1. Setup Environment Variables (Replaces submitit logic)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># -------------------------------------------------------</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Setup Output Directory (mimics args.job_dir / args.output_dir)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Really important!! This is the path used to restart the job from a checkpoint</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">JOB_DIR</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;output_dir&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Output Directory: </span><span class="token string variable" style="color:#36acaa">$JOB_DIR</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># IMPORTANT: WORLD_SIZE must match ntasks (6 nodes * 2 tasks = 12)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">WORLD_SIZE</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$((</span><span class="token variable" style="color:#36acaa"> SLURM_NNODES </span><span class="token variable operator" style="color:#393A34">*</span><span class="token variable" style="color:#36acaa"> SLURM_NTASKS_PER_NODE </span><span class="token variable" style="color:#36acaa">))</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># -------------------------------------------------------</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 2. Setup Distributed Initialization (mimics get_init_file)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># -------------------------------------------------------</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># -------------------------------------------------------</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 3. TODO After first sbatch execution !!!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># -------------------------------------------------------</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">RESUME_PATH</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">#${JOB_DIR}/checkpoint.pth # Add the path to ${JOB_DIR}/checkpoint.pth only after the first sbatch is submited </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">RESUME_FLAG</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> -n </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$RESUME_PATH</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token assign-left variable" style="color:#36acaa">RESUME_FLAG</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;--resume </span><span class="token string variable" style="color:#36acaa">$RESUME_PATH</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># -------------------------------------------------------</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 4. Run Command</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># -------------------------------------------------------</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># We use &#x27;srun&#x27; to launch the script on every GPU across all nodes.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># We map Slurm variables to PyTorch variables so the script knows its rank.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">srun apptainer </span><span class="token builtin class-name">exec</span><span class="token plain"> --nv --bind /tmpdir,/work </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --env </span><span class="token assign-left variable" style="color:#36acaa">TORCH_HOME</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$TORCH_HOME</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --env </span><span class="token assign-left variable" style="color:#36acaa">TORCHFIDELITY_HOME</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">torch_home </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --nv /work/conteneurs/sessions-interactives/pytorch-25.01-py3-calmip-si-latest.sif </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">bash</span><span class="token plain"> -c </span><span class="token string" style="color:#e3116c">&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    # 1. Export Distributed Variables so Python finds them automatically</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    export RANK=\</span><span class="token string variable" style="color:#36acaa">$SLURM_PROCID</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    export LOCAL_RANK=\</span><span class="token string variable" style="color:#36acaa">$SLURM_LOCALID</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    export WORLD_SIZE=</span><span class="token string variable" style="color:#36acaa">$WORLD_SIZE</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    export MASTER_ADDR=</span><span class="token string variable" style="color:#36acaa">$MASTER_ADDR</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    export MASTER_PORT=</span><span class="token string variable" style="color:#36acaa">$MASTER_PORT</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    echo </span><span class="token string entity" style="color:#36acaa">\&quot;</span><span class="token string" style="color:#e3116c">Rank \</span><span class="token string variable" style="color:#36acaa">$RANK</span><span class="token string" style="color:#e3116c"> (Local \</span><span class="token string variable" style="color:#36acaa">$LOCAL_RANK</span><span class="token string" style="color:#e3116c">) on \</span><span class="token string variable" style="color:#36acaa">$(</span><span class="token string variable function" style="color:#d73a49">hostname</span><span class="token string variable" style="color:#36acaa">)</span><span class="token string entity" style="color:#36acaa">\&quot;</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    # 2. Run Python WITHOUT the conflicting flags (--rank, --gpu, --job_dir)</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    python train.py \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        --dist_url &#x27;env://&#x27; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        --output_dir &#x27;</span><span class="token string variable" style="color:#36acaa">${JOB_DIR}</span><span class="token string" style="color:#e3116c">&#x27; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        </span><span class="token string variable" style="color:#36acaa">${RESUME_FLAG}</span><span class="token string" style="color:#e3116c"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        --data_path &#x27;</span><span class="token string variable" style="color:#36acaa">${IMAGENET_DIR}</span><span class="token string" style="color:#e3116c">train_blurred_</span><span class="token string variable" style="color:#36acaa">$IMAGENET_RES</span><span class="token string" style="color:#e3116c">/box/&#x27; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        --lr 4e-4 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        --batch_size 512 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        --accum_iter 1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        --eval_frequency 100 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        --decay_lr \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        --compute_fid \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        --ode_method dopri5 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        --ode_options &#x27;{</span><span class="token string entity" style="color:#36acaa">\&quot;</span><span class="token string" style="color:#e3116c">atol</span><span class="token string entity" style="color:#36acaa">\&quot;</span><span class="token string" style="color:#e3116c">: 1e-5, </span><span class="token string entity" style="color:#36acaa">\&quot;</span><span class="token string" style="color:#e3116c">rtol</span><span class="token string entity" style="color:#36acaa">\&quot;</span><span class="token string" style="color:#e3116c">:1e-5}&#x27; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        </span><span class="token string entity" style="color:#36acaa">\&quot;</span><span class="token string" style="color:#e3116c">\</span><span class="token string variable" style="color:#36acaa">$@</span><span class="token string entity" style="color:#36acaa">\&quot;</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    &quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><blockquote><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><ul><li><code>WORLD_SIZE</code> doit correspondre au nombre total de tâches (ntasks).  </li><li><code>JOB_DIR</code> est crucial : toutes les runs doivent pointer vers un <code>--output_dir</code> identique pour reprendre depuis le checkpoint.</li></ul></div></div></blockquote><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="préparation-du-dataset-imagenet32-blurred">Préparation du dataset ImageNet32 (Blurred)<a href="#préparation-du-dataset-imagenet32-blurred" class="hash-link" aria-label="Direct link to Préparation du dataset ImageNet32 (Blurred)" title="Direct link to Préparation du dataset ImageNet32 (Blurred)">​</a></h2><p>Placer les données sous :</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">examples/image/data/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Téléchargement (méthode générique) :</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> https://image-net.org/data/ILSVRC/blurred/train_blurred.tar.gz</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Si le lien change :</p><ol><li>Créez un compte sur <a href="https://image-net.org" target="_blank" rel="noopener noreferrer">https://image-net.org</a>  </li><li>Allez dans <strong>Downloads</strong>  </li><li>Télécharger <em>Blurred training images</em>  </li><li>Clic droit → <em>Copy link</em> → <code>wget &lt;link&gt;</code></li></ol><p>Décompressez dans : <code>examples/image/data/train_blurred_32/box/</code> (ou la résolution choisie).</p><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="téléchargement-dinception-v3-poids-pour-fid">Téléchargement d&#x27;Inception v3 (poids pour FID)<a href="#téléchargement-dinception-v3-poids-pour-fid" class="hash-link" aria-label="Direct link to Téléchargement d&#x27;Inception v3 (poids pour FID)" title="Direct link to Téléchargement d&#x27;Inception v3 (poids pour FID)">​</a></h2><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> https://github.com/toshas/torch-fidelity/releases/download/v0.2.0/weights-inception-2015-12-05-6726825d.pth</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Les poids sont places dans :</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">examples/image/torch_home/hub/checkpoints/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>La variable TORCH_HOME est définie:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">TORCH_HOME</span><span class="token operator" style="color:#393A34">=</span><span class="token environment constant" style="color:#36acaa">$PWD</span><span class="token plain">/examples/image/torch_home</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><blockquote><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p><code>torch_fidelity</code> et <code>torch.hub</code> cherchent par défaut dans <code>$TORCH_HOME/hub/checkpoints/</code>. Assurez‑vous que le fichier est dans ce dossier et que <code>TORCH_HOME</code> est exporté <strong>avant</strong> de lancer l&#x27;entraînement.</p></div></div></blockquote><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="modifications-apportées-au-code">Modifications apportées au code<a href="#modifications-apportées-au-code" class="hash-link" aria-label="Direct link to Modifications apportées au code" title="Direct link to Modifications apportées au code">​</a></h2><p>Pour que tout fonctionne sur notre cluster, j&#x27;ai appliqué les modifications suivantes :</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-chargement-sécurisé-des-checkpoints">1) Chargement sécurisé des checkpoints<a href="#1-chargement-sécurisé-des-checkpoints" class="hash-link" aria-label="Direct link to 1) Chargement sécurisé des checkpoints" title="Direct link to 1) Chargement sécurisé des checkpoints">​</a></h3><p>Dans <code>training/load_and_save.py</code>, ligne autour de 54 :<br>
<!-- -->Remplacez la ligne</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">checkpoint </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">load</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">args</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">resume</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> map_location</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;cpu&quot;</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>par :</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">checkpoint </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">load</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">args</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">resume</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> map_location</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;cpu&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> weights_only</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Ceci évite l&#x27;erreur liée à <code>argparse.Namespace</code> sous les versions récentes de PyTorch.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-sauvegarde-systématique-du-modèle-à-chaque-epoch-sans-accumuler-de-fichiers">2) Sauvegarde systématique du modèle à chaque epoch (sans accumuler de fichiers)<a href="#2-sauvegarde-systématique-du-modèle-à-chaque-epoch-sans-accumuler-de-fichiers" class="hash-link" aria-label="Direct link to 2) Sauvegarde systématique du modèle à chaque epoch (sans accumuler de fichiers)" title="Direct link to 2) Sauvegarde systématique du modèle à chaque epoch (sans accumuler de fichiers)">​</a></h3><p>Dans <code>train.py</code>, nous activons la sauvegarde automatique à chaque fin d’epoch pour
garantit qu’on peut reprendre l’entraînement à tout moment depuis le dernier état.</p><p>Le bloc utilisé est :</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># --------------------------------------------------------------------------</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Save *one* checkpoint at the end of each epoch (overwrite previous)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># --------------------------------------------------------------------------</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">output_dir </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> distributed_mode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">is_main_process</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    save_model</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        args</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">args</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        model</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        model_without_ddp</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">model_without_ddp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        optimizer</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">optimizer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        lr_schedule</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">lr_schedule</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        loss_scaler</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">loss_scaler</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        epoch</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">epoch</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># --------------------------------------------------------------------------</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>et dans <code>training/load_and_save.py</code> une ligne est commenté pour pas
empecher la generation de checkpoint pour chaque epoch et éviter ansi de consommer trop d’inodes dans /tmpdir,</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">checkpoint_paths </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#    output_dir / (&quot;checkpoint-%s.pth&quot; % epoch_name),</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    output_dir </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;checkpoint.pth&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="non-utilisation-de-submitit_trainpy">Non utilisation de submitit_train.py<a href="#non-utilisation-de-submitit_trainpy" class="hash-link" aria-label="Direct link to Non utilisation de submitit_train.py" title="Direct link to Non utilisation de submitit_train.py">​</a></h2><div class="theme-admonition theme-admonition-caution alert alert--warning admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>caution</div><div class="admonitionContent_S0QG"><ul><li><code>submitit_train.py</code> dans le repo génère des scripts SLURM qui peuvent ne pas être conteneur-aware. Dans notre setup Apptainer il était plus simple d&#x27;appeler <code>train.py</code> directement dans le conteneur via <code>srun apptainer exec ...</code>.</li></ul></div></div><hr></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/documentation/user-documentation/arch_exp/turpan/ressources_ia/HPO/ray_tune"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Ray Tune</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/documentation/user-documentation/arch_exp/turpan/soumettre_calcul/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Lancer un calcul</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#preparation-du-projet-recuperation-du-dossier--installation-de-dependences" class="table-of-contents__link toc-highlight">Preparation du projet. Recuperation du dossier + installation de dependences.</a></li><li><a href="#lancer-le-calcul" class="table-of-contents__link toc-highlight">Lancer le calcul</a></li><li><a href="#résultats-dexécution-attendus-sur-le-cluster" class="table-of-contents__link toc-highlight">Résultats d’exécution attendus sur le cluster.</a></li><li><a href="#script-danalyse-et-de-visualisation-de-lapprentissage-du-modèle-process_and_plot_lr_losspy" class="table-of-contents__link toc-highlight">Script d’analyse et de visualisation de l’apprentissage du modèle process_and_plot_lr_loss.py</a></li><li><a href="#script-slurm-pour-lancer-lévaluation-fid-depuis-un-checkpointpth--script_sbatch_evaluationsh" class="table-of-contents__link toc-highlight">Script Slurm pour lancer l’évaluation FID depuis un checkpoint.pth : script_sbatch_evaluation.sh</a></li><li><a href="#script-slurm-apptainer--multinœuds" class="table-of-contents__link toc-highlight">Script Slurm (Apptainer + multi‑nœuds)</a></li><li><a href="#préparation-du-dataset-imagenet32-blurred" class="table-of-contents__link toc-highlight">Préparation du dataset ImageNet32 (Blurred)</a></li><li><a href="#téléchargement-dinception-v3-poids-pour-fid" class="table-of-contents__link toc-highlight">Téléchargement d&#39;Inception v3 (poids pour FID)</a></li><li><a href="#modifications-apportées-au-code" class="table-of-contents__link toc-highlight">Modifications apportées au code</a><ul><li><a href="#1-chargement-sécurisé-des-checkpoints" class="table-of-contents__link toc-highlight">1) Chargement sécurisé des checkpoints</a></li><li><a href="#2-sauvegarde-systématique-du-modèle-à-chaque-epoch-sans-accumuler-de-fichiers" class="table-of-contents__link toc-highlight">2) Sauvegarde systématique du modèle à chaque epoch (sans accumuler de fichiers)</a></li></ul></li><li><a href="#non-utilisation-de-submitit_trainpy" class="table-of-contents__link toc-highlight">Non utilisation de submitit_train.py</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright 2025 Mesonet</div></div></div></footer></div>
<script src="/documentation/user-documentation/assets/js/runtime~main.133bebb2.js"></script>
<script src="/documentation/user-documentation/assets/js/main.55ebcb72.js"></script>
</body>
</html>